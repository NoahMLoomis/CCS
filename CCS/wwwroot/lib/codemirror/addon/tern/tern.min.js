!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],t):t(CodeMirror)}(function(g){"use strict";g.TernServer=function(t){var n=this;this.options=t||{};t=this.options.plugins||(this.options.plugins={});t.doc_comment||(t.doc_comment=!0),this.docs=Object.create(null),this.options.useWorker?this.server=new i(this):this.server=new tern.Server({getFile:function(t,e){return s(n,t,e)},async:!0,defs:this.options.defs||[],plugins:t}),this.trackChange=function(t,e){!function(t,e,n){var o=u(t,e),i=t.cachedArgHints;i&&i.doc==e&&0<=y(i.start,n.to)&&(t.cachedArgHints=null);var r=o.changed;null==r&&(o.changed=r={from:n.from.line,to:n.from.line});i=n.from.line+(n.text.length-1);n.from.line<r.to&&(r.to=r.to-(n.to.line-i));i>=r.to&&(r.to=i+1);r.from>n.from.line&&(r.from=n.from.line);e.lineCount()>l&&100<n.to-r.from&&setTimeout(function(){o.changed&&100<o.changed.to-o.changed.from&&a(t,o)},200)}(n,t,e)},this.cachedArgHints=null,this.activeArgHints=null,this.jumpStack=[],this.getHint=function(t,e){var l,u,f;u=t,f=e,(l=n).request(u,{type:"completions",types:!0,docs:!0,urls:!0},function(t,e){if(t)return k(l,u,t);var n=[],o="",i=e.start,t=e.end;'["'==u.getRange(m(i.line,i.ch-2),i)&&'"]'!=u.getRange(t,m(t.line,t.ch+2))&&(o='"]');for(var r=0;r<e.completions.length;++r){var s=e.completions[r],a=function(t){t="?"==t?"unknown":"number"==t||"string"==t||"bool"==t?t:/^fn\(/.test(t)?"fn":/^\[/.test(t)?"array":"object";return d+"completion "+d+"completion-"+t}(s.type);e.guess&&(a+=" "+d+"guess"),n.push({text:s.name+o,displayText:s.displayName||s.name,className:a,data:s})}var t={from:i,to:t,list:n},c=null;g.on(t,"close",function(){T(c)}),g.on(t,"update",function(){T(c)}),g.on(t,"select",function(t,e){T(c);t=l.options.completionTip?l.options.completionTip(t.data):t.data.doc;t&&(c=b(e.parentNode.getBoundingClientRect().right+window.pageXOffset,e.getBoundingClientRect().top+window.pageYOffset,t,u,d+"hint-doc"))}),f(t)})},this.getHint.async=!0},g.TernServer.prototype={addDoc:function(t,e){var n={doc:e,name:t,changed:null};return this.server.addFile(t,D(this,n)),g.on(e,"change",this.trackChange),this.docs[t]=n},delDoc:function(t){t=e(this,t);t&&(g.off(t.doc,"change",this.trackChange),delete this.docs[t.name],this.server.delFile(t.name))},hideDoc:function(t){A(this);t=e(this,t);t&&t.changed&&a(this,t)},complete:function(t){t.showHint({hint:this.getHint})},showType:function(t,e,n){o(this,t,e,"type",n)},showDocs:function(t,e,n){o(this,t,e,"documentation",n)},updateArgHints:function(t){!function(n,o){if(A(n),!o.somethingSelected()){var t=o.getTokenAt(o.getCursor()).state,t=g.innerMode(o.getMode(),t);if("javascript"==t.mode.name){var e=t.state.lexical;if("call"==e.info){for(var i,r=e.pos||0,s=o.getOption("tabSize"),a=o.getCursor().line,c=Math.max(0,a-9),l=!1;c<=a;--a){for(var u=o.getLine(a),f=0,d=0;;){var p=u.indexOf("\t",d);if(-1==p)break;f+=s-(p+f)%s-1,d=p+1}if(i=e.column-f,"("==u.charAt(i)){l=!0;break}}if(l){var h=m(a,i),t=n.cachedArgHints;if(t&&t.doc==o.getDoc()&&0==y(h,t.start))return v(n,o,r);n.request(o,{type:"type",preferFunction:!0,end:h},function(t,e){!t&&e.type&&/^fn\(/.test(e.type)&&(n.cachedArgHints={start:h,type:function(i){var t=[],r=3;if(")"!=i.charAt(r))for(;;){var e=i.slice(r).match(/^([^, \(\[\{]+): /);if(e&&(r+=e[0].length,e=e[1]),t.push({name:e,type:function(t){for(var e=0,n=r;;){var o=i.charAt(r);if(t.test(o)&&!e)return i.slice(n,r);/[{\[\(]/.test(o)?++e:/[}\]\)]/.test(o)&&--e,++r}}(/[\),]/)}),")"==i.charAt(r))break;r+=2}var n=i.slice(r).match(/^\) -> (.*)$/);return{args:t,rettype:n&&n[1]}}(e.type),name:e.exprName||e.name||"fn",guess:e.guess,doc:o.getDoc()},v(n,o,r))})}}}}}(this,t)},jumpToDef:function(t){function e(t){var t={type:"definition",variable:t||null},o=u(i,r.getDoc());i.server.request(p(i,o,t),function(t,e){if(t)return k(i,r,t);if(e.file||!e.url){if(e.file){var n,t=i.docs[e.file];if(t&&(n=function(t,e){for(var n=e.context.slice(0,e.contextOffset).split("\n"),o=e.start.line-(n.length-1),i=m(o,(1==n.length?e.start.ch:t.getLine(o).length)-n[0].length),r=t.getLine(o).slice(i.ch),s=1+o;s<t.lineCount()&&r.length<e.context.length;++s)r+="\n"+t.getLine(s);if(r.slice(0,e.context.length)==e.context)return e;var a,c=t.getSearchCursor(e.context,0,!1),l=1/0;for(;c.findNext();){var u=c.from(),f=1e4*Math.abs(u.line-i.line);(f=f||Math.abs(u.ch-i.ch))<l&&(a=u,l=f)}if(!a)return null;1==n.length?a.ch+=n[0].length:a=m(a.line+(n.length-1),n[n.length-1].length);n=e.start.line==e.end.line?m(a.line,a.ch+(e.end.ch-e.start.ch)):m(a.line+(e.end.line-e.start.line),e.end.ch);return{start:a,end:n}}(t.doc,e)))return i.jumpStack.push({file:o.name,start:r.getCursor("from"),end:r.getCursor("to")}),void c(i,o,t,n.start,n.end)}k(i,r,"Could not find a definition.")}else window.open(e.url)})}var i,r;i=this,!function(t){var e=t.getCursor("end"),n=t.getTokenAt(e);return!(n.start<e.ch&&"comment"==n.type)&&/[\w)\]]/.test(t.getLine(e.line).slice(Math.max(e.ch-1,0),e.ch+1))}(r=t)?C(r,"Jump to variable",function(t){t&&e(t)}):e()},jumpBack:function(t){var e,n,o;n=t,o=(e=this).jumpStack.pop(),(t=o&&e.docs[o.file])&&c(e,u(e,n.getDoc()),t,o.start,o.end)},rename:function(t){!function(n,o){var t=o.getTokenAt(o.getCursor());if(!/\w/.test(t.string))return k(n,o,"Not at a variable");C(o,"New name for "+t.string,function(t){n.request(o,{type:"rename",newName:t,fullDocs:!0},function(t,e){return t?k(n,o,t):void function(t,e){for(var n,o=Object.create(null),i=0;i<e.length;++i){var r=e[i];(o[r.file]||(o[r.file]=[])).push(r)}for(n in o){var s=t.docs[n],a=o[n];if(s){a.sort(function(t,e){return y(e.start,t.start)});for(var c="*rename"+ ++f,i=0;i<a.length;++i){r=a[i];s.doc.replaceRange(r.text,r.start,r.end,c)}}}}(n,e.changes)})})}(this,t)},selectName:function(t){var a,c,l;l=u(a=this,(c=t).doc).name,a.request(c,{type:"refs"},function(t,e){if(t)return k(a,c,t);for(var n=[],o=0,i=c.getCursor(),r=0;r<e.refs.length;r++){var s=e.refs[r];s.file==l&&(n.push({anchor:s.start,head:s.end}),0<=y(i,s.start)&&y(i,s.end)<=0&&(o=n.length-1))}c.setSelections(n,o)})},request:function(t,n,o,e){var i=this,r=u(this,t.getDoc()),s=p(this,r,n,e),a=s.query&&this.options.queryOptions&&this.options.queryOptions[s.query.type];if(a)for(var c in a)s.query[c]=a[c];this.server.request(s,function(t,e){!t&&i.options.responseFilter&&(e=i.options.responseFilter(r,n,s,t,e)),o(t,e)})},destroy:function(){A(this),this.worker&&(this.worker.terminate(),this.worker=null)}};var m=g.Pos,d="CodeMirror-Tern-",l=250;function s(t,e,n){var o=t.docs[e];o?n(D(t,o)):t.options.getFile?t.options.getFile(e,n):n(null)}function u(t,e,n){for(var o in t.docs){var i=t.docs[o];if(i.doc==e)return i}if(!n)for(var r=0;;++r)if(!t.docs[o="[doc"+(r||"")+"]"]){n=o;break}return t.addDoc(n,e)}function e(t,e){return"string"==typeof e?t.docs[e]:(e=e instanceof g?e.getDoc():e)instanceof g.Doc?u(t,e):void 0}function a(t,e){t.server.request({files:[{type:"full",name:e.name,text:D(t,e)}]},function(t){t?window.console.error(t):e.changed=null})}function o(o,i,t,e,r){o.request(i,e,function(t,e){return t?k(o,i,t):(o.options.typeTip?n=o.options.typeTip(e):(n=h("span",null,h("strong",null,e.type||"not found")),e.doc&&n.appendChild(document.createTextNode(" — "+e.doc)),e.url&&(n.appendChild(document.createTextNode(" ")),(t=n.appendChild(h("a",null,"[docs]"))).href=e.url,t.target="_blank")),x(i,n,o),void(r&&r()));var n},t)}function v(t,e,n){A(t);for(var o=t.cachedArgHints,i=o.type,r=h("span",o.guess?d+"fhint-guess":null,h("span",d+"fname",o.name),"("),s=0;s<i.args.length;++s){s&&r.appendChild(document.createTextNode(", "));var a=i.args[s];r.appendChild(h("span",d+"farg"+(s==n?" "+d+"farg-current":""),a.name||"?")),"?"!=a.type&&(r.appendChild(document.createTextNode(": ")),r.appendChild(h("span",d+"type",a.type)))}r.appendChild(document.createTextNode(i.rettype?") -> ":")")),i.rettype&&r.appendChild(h("span",d+"type",i.rettype));var o=e.cursorCoords(null,"page"),c=t.activeArgHints=b(o.right+1,o.bottom,r,e);setTimeout(function(){c.clear=w(e,function(){t.activeArgHints==c&&A(t)})},20)}function c(t,e,n,o,i){n.doc.setSelection(o,i),e!=n&&t.options.switchToDoc&&(A(t),t.options.switchToDoc(n.name,n.doc))}var f=0;function p(t,e,n,o){var i=[],r=0,s=!n.fullDocs;s||delete n.fullDocs,(n="string"==typeof n?{type:n}:n).lineCharPositions=!0,null==n.end&&(n.end=o||e.doc.getCursor("end"),e.doc.somethingSelected()&&(n.start=e.doc.getCursor("start")));var a,o=n.start||n.end;for(a in e.changed?e.doc.lineCount()>l&&!1!=s&&e.changed.to-e.changed.from<100&&e.changed.from<=o.line&&e.changed.to>n.end.line?(i.push(function(t,e,n){for(var o,i=t.doc,r=null,s=null,a=e.line-1,c=Math.max(0,a-50);c<=a;--a){var l=i.getLine(a);l.search(/\bfunction\b/)<0||(f=g.countColumn(l,null,4),null!=r&&r<=f||(r=f,s=a))}null==s&&(s=c);var u=Math.min(i.lastLine(),n.line+20);if(null==r||r==g.countColumn(i.getLine(e.line),null,4))o=u;else for(o=n.line+1;o<u;++o){var f;if((f=g.countColumn(i.getLine(o),null,4))<=r)break}e=m(s,0);return{type:"part",name:t.name,offsetLines:e.line,text:i.getRange(e,m(o,n.line==o?null:0))}}(e,o,n.end)),n.file="#0",r=i[0].offsetLines,null!=n.start&&(n.start=m(n.start.line- -r,n.start.ch)),n.end=m(n.end.line-r,n.end.ch)):(i.push({type:"full",name:e.name,text:D(t,e)}),n.file=e.name,e.changed=null):n.file=e.name,t.docs){var c=t.docs[a];c.changed&&c!=e&&(i.push({type:"full",name:c.name,text:D(t,c)}),c.changed=null)}return{query:n,files:i}}var y=g.cmpPos;function h(t,e){var n=document.createElement(t);e&&(n.className=e);for(var o=2;o<arguments.length;++o){var i=arguments[o];"string"==typeof i&&(i=document.createTextNode(i)),n.appendChild(i)}return n}function C(t,e,n){t.openDialog?t.openDialog(e+": <input type=text>",n):n(prompt(e,""))}function x(e,t,n){e.state.ternTooltip&&T(e.state.ternTooltip);var o=e.cursorCoords(),i=e.state.ternTooltip=b(o.right+1,o.bottom,t,e);function r(){var t;e.state.ternTooltip=null,i.parentNode&&((t=i).style.opacity="0",setTimeout(function(){T(t)},1100)),c()}var s=!1,a=!1;g.on(i,"mousemove",function(){s=!0}),g.on(i,"mouseout",function(t){t=t.relatedTarget||t.toElement;t&&g.contains(i,t)||(a?r():s=!1)}),setTimeout(function(){a=!0,s||r()},n.options.hintDelay||1700);var c=w(e,r)}function w(t,e){return t.on("cursorActivity",e),t.on("blur",e),t.on("scroll",e),t.on("setDoc",e),function(){t.off("cursorActivity",e),t.off("blur",e),t.off("scroll",e),t.off("setDoc",e)}}function b(t,e,n,o,i){var r=h("div",d+"tooltip "+(i||""),n);r.style.left=t+"px",r.style.top=e+"px",(((o.options||{}).hintOptions||{}).container||document.body).appendChild(r);var s=o.cursorCoords(),a=window.innerWidth,c=window.innerHeight,i=r.getBoundingClientRect(),n=document.querySelector(".CodeMirror-hints"),e=i.bottom-c,o=i.right-a;return n&&0<o&&(r.style.left=0,i=r.getBoundingClientRect(),r.style.left=(t=t-n.offsetWidth-i.width)+"px",o=i.right-a),0<e&&(e=i.bottom-i.top,0<s.top-(s.bottom-i.top)-e?r.style.top=s.top-e+"px":c<e&&(r.style.height=c-5+"px",r.style.top=s.bottom-i.top+"px")),0<o&&(i.right-i.left>a&&(r.style.width=a-5+"px",o-=i.right-i.left-a),r.style.left=t-o+"px"),r}function T(t){var e=t&&t.parentNode;e&&e.removeChild(t)}function k(t,e,n){t.options.showError?t.options.showError(e,n):x(e,String(n),t)}function A(t){t.activeArgHints&&(t.activeArgHints.clear&&t.activeArgHints.clear(),T(t.activeArgHints),t.activeArgHints=null)}function D(t,e){var n=e.doc.getValue();return n=t.options.fileFilter?t.options.fileFilter(n,e.name,e.doc):n}function i(e){var n=e.worker=new Worker(e.options.workerScript);n.postMessage({type:"init",defs:e.options.defs,plugins:e.options.plugins,scripts:e.options.workerDeps});var o=0,i={};function r(t,e){e&&(t.id=++o,i[o]=e),n.postMessage(t)}n.onmessage=function(t){var n=t.data;"getFile"==n.type?s(e,n.name,function(t,e){r({type:"getFile",err:String(t),text:e,id:n.id})}):"debug"==n.type?window.console.log(n.message):n.id&&i[n.id]&&(i[n.id](n.err,n.body),delete i[n.id])},n.onerror=function(t){for(var e in i)i[e](t);i={}},this.addFile=function(t,e){r({type:"add",name:t,text:e})},this.delFile=function(t){r({type:"del",name:t})},this.request=function(t,e){r({type:"req",body:t},e)}}});